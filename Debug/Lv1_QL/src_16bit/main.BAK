/*
 IPRT/AMATERAS Level1 Data QL
 author : F. Tsuchiya @ Oct. 8, 2013
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "cpgplot.h"

#define NA (10)
#define NB (6)
#define M (60000)   /* number of time step (100*120sec*5) */
#define N (6554)    /* frequency channel of each pol */

/* proto-type decl. */
static void get_data (char *fn, unsigned char *dr, unsigned char *dl);
static void init_pgplot(char *str);
static void plot_wedge(float fmin, float fmax);
static void plot_data(unsigned char *dr, unsigned char *dl);

/* public variable */
int ncol = 64;
float vpx1 = 0.15, vpx2 = 0.85, vpy1 = 0.15, vpy2 = 0.9;
char infile[128];

/*----------------------------------------------------------*
 * main routine
 *----------------------------------------------------------*/
int main(int argc, char *argv[]){

  unsigned char *dr;
  unsigned char *dl;
  char          cmd[128];
  FILE          *fp;
  int n = N/NB;
  int m = M/NA;

  /* input data file */
  if (argc != 2){
    printf ("usage $ main yyyymmdd\n");
    return;
  }

  sprintf(cmd,"ls -tr %s/*_Lv1_*.dat    > filelist.dat",argv[1]);
  system(cmd);
  fp = fopen("filelist.dat","r");

  dr = (unsigned char *)malloc (m*n);
  dl = (unsigned char *)malloc (m*n);

  /* plot data */
  init_pgplot(argv[1]);

  while(1){

    fscanf(fp,"%s",infile);
    if (feof(fp)) break;
    printf("input %s\n",infile);

    memset(dr,0x0,sizeof(dr));
    memset(dl,0x0,sizeof(dl)); 
    get_data(infile,dr,dl);

    plot_data(dr,dl);
    cpgpage();
  }

  cpgend();

  free (dr);
  free (dl);

  fclose (fp);

  /* make pdf */
  sprintf(cmd,"ps2pdf IPRT-SUN-Lv1-%s.ps",argv[1]);
  system (cmd);
  sprintf(cmd,"rm -f IPRT-SUN-Lv1-%s.ps",argv[1]);
  system (cmd);

  return;

}

/*----------------------------------------------------------*
 *  Get Data
 *  (read every NA spectra)
 *----------------------------------------------------------*/
static void get_data(char *fn, unsigned char *dr, unsigned char *dl){

  FILE *fp;
  int i,j;
  int ii;
  unsigned char *dat;
  int n = N/NB;
  int m = M/NA;

  dat = malloc(N*NA);

  fp = fopen(fn,"rb");

  for(i=0;i<m;i++){
    fread (dat, sizeof(unsigned char), N*NA, fp);
    for (j=0;j<n;j++){
      ii = j + i*n;
      dr[ii] = dat[j*NB];
    }
  }
  for(i=0;i<m;i++){
    fread (dat, sizeof(unsigned char), N*NA, fp);
    for (j=0;j<n;j++){
      ii = j + i*n;
      dl[ii] = dat[j*NB];
    }
  }

  free (dat);
  fclose (fp);
  
  return;
}

/*----------------------------------------------------------* 
 *  Init PGPLOT
 *----------------------------------------------------------*/
static void init_pgplot(char* str)
{

  float c1,c2,c3;
  int   i;
  char  ps[64];

  sprintf(ps,"IPRT-SUN-Lv1-%s.ps/cps",str);
  printf("output %s\n",ps);
  cpgbeg (0,ps,1,2);
  //  cpgbeg (0,"/xs",1,2);

  cpgsch(2.0);

  /* color code */ 
  c1 = 360.0;
  c3 = 1.0;
  for (i=0;i<ncol;i++){
    c2 = (float)i/(float)(ncol-1);
    cpgshls(16+i,c1,c2,c3);
  }
  /*
  c2 = 0.5;
  c3 = 1.0;
  for (i=0;i<ncol;i++){
    c1 = 360.0-240.0*(float)i/(float)(ncol-1);
    cpgshls(16+i,c1,c2,c3);
  }
  */

  return;
}

/*----------------------------------------------------------*
 *  Plot wedge
 *----------------------------------------------------------*/
static void plot_wedge(float fmin, float fmax)
{

  int j;
  float y1,y2;

  cpgsvp(vpx2+0.01,vpx2+0.02,vpy1,vpy2);
  cpgswin(0.0,1.0,fmin,fmax);

  for(j=0;j<ncol;j++){
    y1 = fmin + (float)j/(float)ncol*(fmax-fmin); 
    y2 = y1 + (fmax-fmin)/(float)ncol;
    cpgsci(16+j);
    cpgrect(0.0,1.0,y1,y2);
  }
  cpgsci(1);
  cpgmtxt("R",2.5,1.0,1.0,"[dB]");

  cpgbox("BC",0.0,0,"BCM",0.0,0);

  return;
}

/*----------------------------------------------------------*
 *  Plot data
 *----------------------------------------------------------*/
static void plot_data(unsigned char *dr, unsigned char *dl){

  int i,j,k,k2;
  float *img;
  float tr[]={0.0,1.0,0.0,0.0,0.0,1.0};
  float ave=0.0,sgm=0.0;
  float fmin,fmax;
  char  label[128];

  int n = N/NB;
  int m = M/NA;

  img = (float *)malloc(sizeof(float)*m*n);
  tr[1] = 600.0/(float)m;
  tr[3] = 100.0;
  tr[5] = 400.0/(float)n;

  /* search range */
  for (i=0;i<m;i++){
    for (j=0;j<n;j++){
      k = i*n + j;
      ave = ave + (float)dr[k]/256.0*25.5; // [dB]
      ave = ave + (float)dl[k]/256.0*25.5; // [dB]
    }
  }
  ave = ave/(float)(m*n*2);

  for (i=0;i<m;i++){
    for (j=0;j<n;j++){
      k = i*n + j;
      sgm = sgm + ((float)dr[k]/256.0*25.5-ave)*((float)dr[k]/256.0*25.5-ave);
      sgm = sgm + ((float)dl[k]/256.0*25.5-ave)*((float)dl[k]/256.0*25.5-ave);
    }
  }
  sgm = sqrt(sgm/(float)(m*n*2));

  fmin = 0.0;
  fmax = ave + sgm;

  /* plot RCP */

  for (i=0;i<m;i++){
    for (j=0;j<n;j++){
      k = i*n + j;
      k2 = i + j*m;
      img[k2] = -3.0 + (float)dr[k]/256.0*25.5; // [dB]
      if (img[k]<fmin) img[k] = fmin;
      if (img[k]>fmax) img[k] = fmax;
    }
  }

  cpgpanl(1,1);
  cpgsvp(vpx1,vpx2,vpy1,vpy2);
  cpgswin(0.0,600.0,100.0,500.0);
  cpgbox("BCINTS",0.0,0,"BCINTS",0.0,0);

  cpgmtxt("T",0.5,0.0,0.0,infile);
  cpgmtxt("B",2.5,1.0,1.0,"Time [sec]");
  cpgmtxt("L",2.5,1.0,1.0,"Freq. [MHz]");
  cpgmtxt("T",0.5,1.0,1.0,"RCP");
 
  cpgscir(16,15+ncol);
  cpgimag(img,m,n,1,m,1,n,fmin,fmax,tr);
  plot_wedge(fmin,fmax);

  /* plot LCP */

  for (i=0;i<m;i++){
    for (j=0;j<n;j++){
      k = i*n + j;
      k2 = i + j*m;
      img[k2] = -3.0 + (float)dl[k]/256.0*25.5; // [dB]
      if (img[k]<fmin) img[k] = fmin;
      if (img[k]>fmax) img[k] = fmax;
    }
  }

  cpgpanl(1,2);
  cpgsvp(vpx1,vpx2,vpy1,vpy2);
  cpgswin(0.0,600.0,100.0,500.0);
  cpgbox("BCINTS",0.0,0,"BCINTS",0.0,0);

  cpgmtxt("B",2.5,1.0,1.0,"Time [sec]");
  cpgmtxt("L",2.5,1.0,1.0,"Freq. [MHz]");
  cpgmtxt("T",0.5,1.0,1.0,"LCP");

  cpgscir(16,15+ncol);
  cpgimag(img,m,n,1,m,1,n,fmin,fmax,tr);
  plot_wedge(fmin,fmax);

  free (img);

  return;
}
